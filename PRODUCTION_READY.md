# Production-Ready System Construction Guide 🏛️

このドキュメントでは、本プロジェクトが「何」を「どのような手順」で構築し、いかにしてプロダクションレディー（本番投入可能）な品質を実現しているかを解説します。

---

## 🏗️ 構築のステップと設計意図

### 1. セキュリティ基盤の確立 (Security First)
まず最初に、**長期的なアクセスキーを排除**することから始めます。

- **GitHub OIDC (Phase 1)**: AWS Access KeyをGitHubに保存する運用は、流出リスクが高いためプロダクションでは避けられます。OIDC（OpenID Connect）を使って、GitHub Actions実行時のみ有効な「一時的な権限」をAWSから取得する構成を真っ先に構築します。
- **IAM Roleの分離**: 「インフラ構築用(Administrator)」と「ECS実行用(ReadOnly/Specific)」のロールを分けることで、万が一コンテナが侵害されてもインフラ全体が操作されるのを防ぎます。

### 2. 正史の管理 (IaC State Management)
インフラの状態（State）をチームで安全に共有するための「置き場」を確立します。

- **S3 Backend & Lockfile**: `terraform.tfstate` をS3に置くことで、作業PCが壊れてもインフラを復旧可能にします。また、`use_lockfile=true` (S3 native locking) を有効にし、複数のCIや人間が同時に変更を加えてStateが壊れるのを防ぎます。

### 3. 基盤ネットワークの設計 (Network Isolation)
「外から入れる場所」と「外から入れない場所」を厳格に分けます。

- **Public/Private VPC**: ALB（入口）だけをPublicに、ECS/RDS/Redisは全てPrivate Subnetに隠します。
- **NAT Gateway**: Private Subnet内のECSがOSアップデートやライブラリ取得、ECRからのイメージPullを行うために、外向きの一方通行な通信を許可します。

### 4. 実行プラットフォーム (Container Orchestration)
サーバー管理のコストを最小化しつつ、高可用性を実現します。

- **ECS Fargate**: EC2サーバーの管理（パッチ当て、SSH管理）を不要にし、コンテナ単位のスケーリングに集中します。
- **Deployment Circuit Breaker**: 新しいリリースのヘルスチェックが通らなかった場合、自動で検知して「前の正常なバージョン」に即座にロールバックします。これにより、リリースによるサービス停止リスクを最小化します。

### 5. データと状態の永続化 (Data Layer)
信頼性の高いマネージドサービスを選択し、整合性を担保します。

- **RDS (Multi-AZ Ready)**: 取引や履歴などの「整合性」が重要なデータを管理します。
- **ElastiCache Redis**: APIのセッションやバックグラウンドジョブのキュー、キャッシュをRDSから分離することで、DBの負荷を抑え、システムの応答速度を向上させます。

### 6. オブザーバビリティと機密管理 (Ops & Security)
リリース後の運用と、パスワード等の機密情報を安全に扱います。

- **Secrets Manager**: DBのパスワードを Terraform 変数やソースコードに書かず、実行時にのみECSへ注入します。
- **CloudWatch Logs**: 全てのコンテナログを一箇所に集約し、トラブル発生時に「いつ・何が起きたか」を即座に追跡できるようにします。

---

## 📈 プロダクションレディーへのロードマップ

1.  **Bootstrap (共通基盤)**: 権限(OIDC)と置き場(S3)を固める。
2.  **Network App (骨組み)**: ネットワークとロードバランサを立て、通信経路を確立する。
3.  **Datastore (心臓部)**: DBとキャッシュを立ち上げ、データ層を完成させる。
4.  **Compute (実行部)**: コンテナを実行し、ALBからのルーティングを確認する。
5.  **CI/CD Pipeline (自動化)**: 誰でも、いつでも、安全にリリースできる仕組みを回す。

この一連の手順を踏むことで、単なる「動くコード」ではなく、**「持続可能で安全なシステム」**が完成します。
